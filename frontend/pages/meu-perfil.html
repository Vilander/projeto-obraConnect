<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meu Perfil - ObraConnect</title>
    <link rel="stylesheet" href="../style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="../index.html">
          <i class="bi bi-hammer"></i> ObraConnect
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="navbar-nav ms-auto">
            <a class="nav-link" href="../index.html">Início</a>
            <a
              class="nav-link"
              href="#"
              onclick="
                realizarLogout();
                return false;
              "
            >
              <i class="bi bi-box-arrow-right"></i> Sair
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div id="aviso-container"></div>

    <!-- MAIN -->
    <main class="container my-section">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 mb-4">
          <div class="card shadow-sm">
            <div class="card-body text-center">
              <div
                style="
                  font-size: 4rem;
                  color: var(--azul-marinho);
                  margin-bottom: 1rem;
                "
              >
                <i class="bi bi-person-circle"></i>
              </div>
              <h5 id="perfil-nome" class="card-title">-</h5>
              <p class="card-text text-muted" id="perfil-email">-</p>
              <p id="perfil-tipo" class="mb-3">-</p>

              <button
                id="btn-virar-prestador"
                class="btn btn-laranja w-100 mb-2"
                style="display: none"
              >
                <i class="bi bi-briefcase"></i> Virar Prestador
              </button>

              <a
                href="cadastrar-servico.html"
                id="btn-novo-servico"
                class="btn btn-outline-primary w-100"
                style="display: none"
              >
                <i class="bi bi-plus-circle"></i> Novo Serviço
              </a>
            </div>
          </div>

          <div class="card shadow-sm mt-3">
            <div class="card-header bg-azul text-white">
              <h6 class="mb-0">Informações</h6>
            </div>
            <div class="card-body">
              <p class="mb-2">
                <strong id="perfil-login">-</strong><br />
                <small class="text-muted">Usuário</small>
              </p>
              <p class="mb-0">
                <strong id="perfil-data">-</strong><br />
                <small class="text-muted">Cadastrado em</small>
              </p>
            </div>
          </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="col-lg-9">
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-azul text-white">
              <h5 class="mb-0">
                <i class="bi bi-briefcase"></i> Meus Serviços
              </h5>
            </div>
            <div class="card-body">
              <div id="loading-servicos" class="loading">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
              </div>

              <div id="servicos-tabela" style="display: none">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>Foto</th>
                        <th>Título</th>
                        <th>Descrição</th>
                        <th>Status</th>
                        <th>Ações</th>
                      </tr>
                    </thead>
                    <tbody id="meus-servicos-container">
                      <!-- Será preenchido pelo JS -->
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="sem-servicos" style="display: none">
                <div class="alert alert-info text-center">
                  <i class="bi bi-info-circle"></i>
                  Você ainda não tem serviços cadastrados.<br />
                  <a
                    href="cadastrar-servico.html"
                    class="btn btn-sm btn-laranja mt-2"
                  >
                    <i class="bi bi-plus-circle"></i> Cadastrar Primeiro Serviço
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Avaliações -->
          <div class="card shadow-sm">
            <div class="card-header bg-azul text-white">
              <h5 class="mb-0"><i class="bi bi-star"></i> Minhas Avaliações</h5>
            </div>
            <div class="card-body">
              <div id="loading-avaliacoes" class="loading">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
              </div>

              <div id="avaliacoes-container" style="display: none">
                <!-- Será preenchido pelo JS -->
              </div>

              <div id="sem-avaliacoes" style="display: none">
                <div class="alert alert-info text-center">
                  <i class="bi bi-info-circle"></i>
                  Você ainda não fez nenhuma avaliação.<br />
                  <a
                    href="../index.html"
                    class="btn btn-sm btn-outline-primary mt-2"
                  >
                    <i class="bi bi-search"></i> Explorar Serviços
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer>
      <div class="container">
        <div class="footer-bottom">
          <p>&copy; 2026 ObraConnect. Todos os direitos reservados.</p>
        </div>
      </div>
    </footer>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/servicos.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        inicializarAutenticacao();

        // Exigir autenticação
        if (!exigirAutenticacao()) return;

        // Preencher dados do perfil
        document.getElementById("perfil-nome").textContent = usuarioLogado.nome;
        document.getElementById("perfil-email").textContent =
          usuarioLogado.email;
        document.getElementById("perfil-login").textContent =
          usuarioLogado.email || "-";
        document.getElementById("perfil-tipo").innerHTML =
          `<span class="badge bg-${usuarioLogado.tipo_usuario === "prestador" ? "laranja" : "info"}">${usuarioLogado.tipo_usuario.toUpperCase()}</span>`;

        // Mostrar botão "Virar Prestador" se for usuário comum
        if (usuarioLogado.tipo_usuario === "usuario") {
          document.getElementById("btn-virar-prestador").style.display =
            "block";
          document
            .getElementById("btn-virar-prestador")
            .addEventListener("click", async () => {
              if (await tornarPrestadorUsuario()) {
                setTimeout(() => {
                  location.reload();
                }, 2000);
              }
            });
        } else {
          document.getElementById("btn-novo-servico").style.display = "block";
        }

        // Data de cadastro
        const dataCadastro = new Date().toLocaleDateString("pt-BR");
        document.getElementById("perfil-data").textContent = dataCadastro;

        // Carregar serviços se for prestador
        if (
          usuarioLogado.tipo_usuario === "prestador" ||
          usuarioLogado.tipo_usuario === "admin"
        ) {
          carregarMeusServicos();
        } else {
          document.getElementById("loading-servicos").style.display = "none";
          document.getElementById("sem-servicos").style.display = "block";
        }

        // Carregar minhas avaliações
        carregarMinhasAvaliacoes();
      });

      async function carregarMinhasAvaliacoes() {
        const container = document.getElementById("avaliacoes-container");
        const loadingDiv = document.getElementById("loading-avaliacoes");
        const semAvalDiv = document.getElementById("sem-avaliacoes");

        try {
          const resultado = await obterMinhasAvaliacoes();

          loadingDiv.style.display = "none";

          if (!resultado.sucesso || resultado.dados.length === 0) {
            semAvalDiv.style.display = "block";
            return;
          }

          container.style.display = "block";
          container.innerHTML = "";

          resultado.dados.forEach((av) => {
            const mediaAvaliacao =
              (av.nota_preco +
                av.nota_tempo_execucao +
                av.nota_higiene +
                av.nota_educacao) /
              4;
            const card = document.createElement("div");
            card.className = "card mb-3";
            card.innerHTML = `
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="card-title mb-1">${av.nome_servico}</h6>
                  <small class="text-muted">Avaliado em ${new Date(av.data_avaliacao).toLocaleDateString("pt-BR")}</small>
                </div>
                <button class="btn btn-sm btn-danger" onclick="deletarAvaliacaoConfirm(${av.id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              <div class="stars mb-2">${renderizarEstrelas(mediaAvaliacao)}</div>
              <p class="card-text">${av.comentario || "Sem comentário"}</p>
            </div>
          `;
            container.appendChild(card);
          });
        } catch (erro) {
          loadingDiv.style.display = "none";
          container.innerHTML =
            '<div class="alert alert-danger">Erro ao carregar avaliações</div>';
        }
      }

      async function deletarAvaliacaoConfirm(id) {
        if (confirm("Tem certeza que deseja deletar esta avaliação?")) {
          const resultado = await deletarAvaliacao(id);
          if (resultado.sucesso) {
            mostrarAviso("Avaliação deletada com sucesso!", "success");
            carregarMinhasAvaliacoes();
          }
        }
      }
    </script>
  </body>
</html>
